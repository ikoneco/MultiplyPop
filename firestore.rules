rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Deny all access by default
    match /{document=**} {
      allow read, write: if false;
    }

    // Users collection - read/write own document only
    match /users/{userId} {
      // Allow authenticated users to read/write their own document
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Validate user document structure on create
      allow create: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.data.keys().hasAll(['email', 'createdAt']) &&
                      request.resource.data.email is string &&
                      request.resource.data.email.size() > 0;

      // Validate user document structure on update
      allow update: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.data.email == resource.data.email && // Email cannot change
                      request.resource.data.createdAt == resource.data.createdAt; // createdAt cannot change
    }

    // Sessions collection - tied to user
    match /sessions/{sessionId} {
      // Allow read if session belongs to authenticated user
      allow read: if request.auth != null && 
                    resource.data.userId == request.auth.uid;

      // Allow create if session is for authenticated user
      allow create: if request.auth != null && 
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.keys().hasAll(['userId', 'platform', 'createdAt', 'lastActive', 'isActive']);

      // Allow update if session belongs to authenticated user
      allow update: if request.auth != null && 
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.userId == resource.data.userId; // userId cannot change

      // Allow delete if session belongs to authenticated user
      allow delete: if request.auth != null && 
                      resource.data.userId == request.auth.uid;
    }

    // Settings collection - user-specific (keyed by userId)
    match /settings/{userId} {
      // Allow authenticated users to read/write their own settings
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Validate settings structure
      allow create: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.data.keys().hasAll(['theme', 'notifications', 'privacy', 'preferences', 'updatedAt']);
    }
  }
}
